<!DOCTYPE html>
<html>
<head>
    <title>Voxel Engine: Movement and Ground</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="overlay">Click to Start and Look Around (WASD to move)</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/PointerLockControls.js"></script> 

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let scene, camera, renderer, controls;
        let ground, cube;

        // Player movement variables
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        const speed = 10.0; // Movement speed

        // --- 2. INITIALIZATION FUNCTION ---
        function init() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 0, 50); // Add a little fog for depth

            // Camera Setup (The camera will be controlled by PointerLockControls)
            const aspectRatio = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 1000);
            camera.position.y = 1.6; // Standard eye level height

            // Renderer Setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // --- 3. GAME OBJECTS ---

            // A. Ground Plane
            const groundGeometry = new THREE.PlaneGeometry(100, 100, 1, 1);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x66cc66 }); // Green grass color
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2; // Rotate to lie flat
            scene.add(ground);

            // B. Simple Cube (Voxel placeholder)
            const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
            const cubeMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
            cube.position.set(0, 0.5, -5); // Place cube in front of start position
            scene.add(cube);

            // C. Lighting (Needed for MeshLambertMaterial)
            const light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
            light.position.set(0.5, 1, 0.75);
            scene.add(light);

            // --- 4. CONTROLS SETUP ---

            controls = new THREE.PointerLockControls(camera, document.body);

            // Get the overlay element
            const overlay = document.getElementById('overlay');

            // Event listener to lock pointer (start game)
            overlay.addEventListener('click', function () {
                controls.lock();
            }, false);

            // Hide overlay when controls are locked
            controls.addEventListener('lock', function () {
                overlay.style.display = 'none';
            });

            // Show overlay when controls are unlocked
            controls.addEventListener('unlock', function () {
                overlay.style.display = 'block';
            });

            // Add controls to the scene (attaches controls to the camera)
            scene.add(controls.getObject());

            // Key press handlers
            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);
        }

        // --- 5. INPUT HANDLERS ---

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW':
                    moveForward = true;
                    break;
                case 'KeyA':
                    moveLeft = true;
                    break;
                case 'KeyS':
                    moveBackward = true;
                    break;
                case 'KeyD':
                    moveRight = true;
                    break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW':
                    moveForward = false;
                    break;
                case 'KeyA':
                    moveLeft = false;
                    break;
                case 'KeyS':
                    moveBackward = false;
                    break;
                case 'KeyD':
                    moveRight = false;
                    break;
            }
        }

        // --- 6. ANIMATION/GAME LOOP ---

        let prevTime = performance.now(); // Track time for smooth movement

        function animate() {
            requestAnimationFrame(animate);

            if (controls.isLocked === true) {
                const time = performance.now();
                const delta = (time - prevTime) / 1000; // Time elapsed since last frame (in seconds)

                // Reset movement vectors
                velocity.x -= velocity.x * speed * delta;
                velocity.z -= velocity.z * speed * delta;
                
                // Calculate movement direction based on key states
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // Ensure diagonal movement isn't faster

                // Apply velocity
                if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;

                // Move the camera/controls
                controls.moveRight(velocity.x * delta);
                controls.moveForward(velocity.z * delta);

                prevTime = time;
            }

            renderer.render(scene, camera);
        }

        // --- 7. RESIZE HANDLER ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- START THE GAME ---
        init();
        animate();
    </script>
</body>
</html>
